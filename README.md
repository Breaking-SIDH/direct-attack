# A direct key recovery attack on SIDH

SageMath implementation following Algorithm 2 of the paper
*A direct key recovery attack on SIDH*.

This algorithm solves the SSI-T problem in subexponential time,
and does not require
knowledge of the endomorphism ring of the starting curve of the
protocol.

**SageMath version**: This code was developed using SageMath version 9.6.
Certain isogeny functions require versions 9.5 and above, and it has
been tested to run correctly with version 9.8, the most recent stable
version (at the time of writing).

We note that the code within `richelot_aux.py` and `speedup.sage`
is based on the work in
[https://github.com/jack4818/Castryck-Decru-SageMath](https://github.com/jack4818/Castryck-Decru-SageMath).
In particular, `richelot_aux.py` contains functions which support
the computation of the gluing, Richelot and splitting isogenies and
`speedup.sage` offers some monkey patches which help SageMath performance
for versions running on 9.6 and below.

The file `generate_public_values.py` is a helper file, which computes
the torsion generators for a given curve, and additionally computes
a SIDH keypair.

The file `attack_aux.py` is a helper file, which contains methods used
in the implementation of the attack. In particular, it contains functions
to compute isogenies defined over $\mathbb F\_{p^2}$ from kernel generators
defined over some field extension of $\mathbb F\_{p^2}$.

Finally, we note that this package should not be considered as an efficient
implementation of the attack described in the paper, but rather as a
proof of concept.

## Instances

This repository currently contains an implementation of the attack
which has been verified to work for the toy example described in the
paper, as well as the "baby" 64-bit prime characteristic used as
a small example [here](https://github.com/jack4818/Castryck-Decru-SageMath/blob/main/baby_SIDH.sage).

## Toy Example

The "toy" example is an attack against
the SSI-T problem for $p = 2^{19}3^{9}-1$. Given only the tuple
$(E_A, \phi_A(P_B), \phi_A(Q_B))$ and the public parameters of the protocol,
this code is able to recover Alice's secret $3^9$-isogeny.
The attack is located within `attack.sage`, which contains detailed
comments which align the code with the steps in algorithm 2.

To perform this attack, following the notation used in the paper,
we begin with the parameter set $(e,i,j,f)=(2,1,0,1042015)$.
Note that the cofactor degree $f$ is smooth and factors as:

$$
f = 5 \cdot 13 \cdot 17 \cdot 23 \cdot 41
$$

Every time the algorithm is launched, a random starting curve is sampled via a
random walk in the supersingular $2$-isogeny graph.
The public parameters $(P_A, Q_A, P_B, Q_B)$ are generated using the method `.gens()`
and therefore are not special in any way. These points are then passed to Alice
who generates her secret key and corresponding public information
$(E_A, \phi_A(P_B), \phi_A(Q_B))$.

Given only the public parameters and Alice's public data, our implementation
of algorithm two allows the recovery of Alice's private key, which is an integer
$x < 3^9$.

Running the script with `sage attack.sage`, an example of the typical output
is given below:

```
User: % sage attack.sage
----------------------------------------------------------------------
The starting curve is
Elliptic Curve defined by y^2 = x^3 + 6*x^2 + (8172480730*i+8271688319)*x + (4955894128*i+2220616971) over Finite Field in i of size 10319560703^2
----------------------------------------------------------------------
The 3^9-torsion group is generated by
(4776588287*i + 7482251465 : 3334445900*i + 7535761668 : 1)
(7435895296*i + 860742880 : 6465258249*i + 8850977057 : 1)
----------------------------------------------------------------------
The 2^19-torsion group is generated by
(194774991*i + 7677586218 : 64211952*i + 7051129925 : 1)
(10090697642*i + 9889940226 : 1011167386*i + 2670271505 : 1)
----------------------------------------------------------------------
The public key is
Elliptic Curve defined by y^2 = x^3 + 6*x^2 + (7040994778*i+9074937999)*x + (8900263712*i+5734165681) over Finite Field in i of size 10319560703^2
(2391024960*i + 4491736297 : 1712247917*i + 4055045192 : 1)
(5528328741*i + 2042683885 : 10242035351*i + 8183312563 : 1)
----------------------------------------------------------------------
If successful, the attack will recover the secret: 7292
----------------------------------------------------------------------
Generating the public parameters for the attack required 0.42s
----------------------------------------------------------------------
Computing cofactor isogeny for prime factor: q = 5
Computing cofactor isogeny for prime factor: q = 13
Computing cofactor isogeny for prime factor: q = 17
Computing cofactor isogeny for prime factor: q = 23
Computing cofactor isogeny for prime factor: q = 41
Computing the dual of the cofactor isogeny required 0.47s
----------------------------------------------------------------------
Guessing the last i=1 step(s)
Trying options for eBlb^(-j)-torsion points
Need to check: 8 pairs of points
----------------------------------------------------------------------
Guessing the last i=1 step(s)
Trying options for eBlb^(-j)-torsion points
Need to check: 8 pairs of points
----------------------------------------------------------------------
Guessing the last i=1 step(s)
Trying options for eBlb^(-j)-torsion points
Need to check: 8 pairs of points
----------------------------------------------------------------------
Guessing the last i=1 step(s)
Trying options for eBlb^(-j)-torsion points
Need to check: 8 pairs of points
----------------------------------------------------------------------
Guessing the correct isogeny required 2.27s
----------------------------------------------------------------------
Secret key recovered: 7292
The attack is successful: True
----------------------------------------------------------------------
Altogether, the attack required 2.80s
```

## Baby Example

The "baby" example breaks
the SSI-T problem for $p = 2^{33}3^{19}-1$,
using attack parameters
$(e,i,j,f)=(3,1,5,225388735)$.

It can be run by invoking the `attack.sage` script with ``baby``
as its first argument, as in the example output below:
```
User: % sage attack.sage baby
----------------------------------------------------------------------
The starting curve is
Elliptic Curve defined by y^2 = x^3 + 6*x^2 + (4099524469992675690*i+451282170789996358)*x + (4934794919117987351*i+7914470780700284169) over Finite Field in i of size 9983749980331966463^2
----------------------------------------------------------------------
The 3^19-torsion group is generated by
(9532122060593410571*i + 2981530272562004730 : 1081141732042869630*i + 8585525908026966534 : 1)
(1422670230884013553*i + 59362039137272976 : 2172587215551817201*i + 9125979755728799789 : 1)
----------------------------------------------------------------------
The 2^33-torsion group is generated by
(9803866262601800443*i + 5601185039984203302 : 8901324830935206044*i + 9467372563989363068 : 1)
(4115364013082997585*i + 9213391420529009714 : 8634795028335550050*i + 5324195425192041246 : 1)
----------------------------------------------------------------------
The public key is
Elliptic Curve defined by y^2 = x^3 + 6*x^2 + (5310080853952048944*i+5397165273668495511)*x + (8195511057816054687*i+128101699630075115) over Finite Field in i of size 9983749980331966463^2
(1655266315147432159*i + 6212540127296821993 : 5088768951649680911*i + 3210848181885895114 : 1)
(609866273128564971*i + 4799207413989404819 : 8018026407632903862*i + 9804895389330803281 : 1)
----------------------------------------------------------------------
If successful, the attack will recover the secret: 314226774
----------------------------------------------------------------------
Generating the public parameters for the attack required 0.48s
----------------------------------------------------------------------
Computing cofactor isogeny for prime factor: q = 5
Computing cofactor isogeny for prime factor: q = 11
Computing cofactor isogeny for prime factor: q = 13
Computing cofactor isogeny for prime factor: q = 19
Computing cofactor isogeny for prime factor: q = 47
Computing cofactor isogeny for prime factor: q = 353
Computing the dual of the cofactor isogeny required 34.52s
----------------------------------------------------------------------
Guessing the last i=3 step(s)
Trying options for eBlb^(-j)-torsion points
Need to check: 1 pairs of points
----------------------------------------------------------------------
Guessing the last i=3 step(s)
Trying options for eBlb^(-j)-torsion points
Need to check: 1 pairs of points
----------------------------------------------------------------------
Guessing the last i=3 step(s)
Trying options for eBlb^(-j)-torsion points
Need to check: 1 pairs of points
----------------------------------------------------------------------
Guessing the last i=3 step(s)
Trying options for eBlb^(-j)-torsion points
Need to check: 1 pairs of points
----------------------------------------------------------------------
Guessing the last i=3 step(s)
Trying options for eBlb^(-j)-torsion points
Need to check: 1 pairs of points
----------------------------------------------------------------------
Guessing the last i=3 step(s)
Trying options for eBlb^(-j)-torsion points
Need to check: 1 pairs of points
----------------------------------------------------------------------
Guessing the last i=3 step(s)
Trying options for eBlb^(-j)-torsion points
Need to check: 1 pairs of points
----------------------------------------------------------------------
Guessing the last i=3 step(s)
Trying options for eBlb^(-j)-torsion points
Need to check: 1 pairs of points
----------------------------------------------------------------------
Guessing the last i=3 step(s)
Trying options for eBlb^(-j)-torsion points
Need to check: 1 pairs of points
----------------------------------------------------------------------
Guessing the last i=3 step(s)
Trying options for eBlb^(-j)-torsion points
Need to check: 1 pairs of points
----------------------------------------------------------------------
Guessing the last i=3 step(s)
Trying options for eBlb^(-j)-torsion points
Need to check: 1 pairs of points
----------------------------------------------------------------------
Guessing the last i=3 step(s)
Trying options for eBlb^(-j)-torsion points
Need to check: 1 pairs of points
----------------------------------------------------------------------
Guessing the last i=3 step(s)
Trying options for eBlb^(-j)-torsion points
Need to check: 1 pairs of points
----------------------------------------------------------------------
Guessing the last i=3 step(s)
Trying options for eBlb^(-j)-torsion points
Need to check: 1 pairs of points
----------------------------------------------------------------------
Guessing the last i=3 step(s)
Trying options for eBlb^(-j)-torsion points
Need to check: 1 pairs of points
----------------------------------------------------------------------
Guessing the last i=3 step(s)
Trying options for eBlb^(-j)-torsion points
Need to check: 1 pairs of points
----------------------------------------------------------------------
Guessing the last i=3 step(s)
Trying options for eBlb^(-j)-torsion points
Need to check: 1 pairs of points
----------------------------------------------------------------------
Guessing the last i=3 step(s)
Trying options for eBlb^(-j)-torsion points
Need to check: 1 pairs of points
----------------------------------------------------------------------
Guessing the last i=3 step(s)
Trying options for eBlb^(-j)-torsion points
Need to check: 1 pairs of points
----------------------------------------------------------------------
Guessing the last i=3 step(s)
Trying options for eBlb^(-j)-torsion points
Need to check: 1 pairs of points
----------------------------------------------------------------------
Guessing the last i=3 step(s)
Trying options for eBlb^(-j)-torsion points
Need to check: 1 pairs of points
----------------------------------------------------------------------
Guessing the last i=3 step(s)
Trying options for eBlb^(-j)-torsion points
Need to check: 1 pairs of points
----------------------------------------------------------------------
Guessing the last i=3 step(s)
Trying options for eBlb^(-j)-torsion points
Need to check: 1 pairs of points
----------------------------------------------------------------------
Guessing the last i=3 step(s)
Trying options for eBlb^(-j)-torsion points
Need to check: 1 pairs of points
----------------------------------------------------------------------
Guessing the last i=3 step(s)
Trying options for eBlb^(-j)-torsion points
Need to check: 1 pairs of points
----------------------------------------------------------------------
Guessing the last i=3 step(s)
Trying options for eBlb^(-j)-torsion points
Need to check: 1 pairs of points
----------------------------------------------------------------------
Guessing the last i=3 step(s)
Trying options for eBlb^(-j)-torsion points
Need to check: 1 pairs of points
----------------------------------------------------------------------
Guessing the last i=3 step(s)
Trying options for eBlb^(-j)-torsion points
Need to check: 1 pairs of points
----------------------------------------------------------------------
Guessing the last i=3 step(s)
Trying options for eBlb^(-j)-torsion points
Need to check: 1 pairs of points
----------------------------------------------------------------------
Guessing the last i=3 step(s)
Trying options for eBlb^(-j)-torsion points
Need to check: 1 pairs of points
----------------------------------------------------------------------
Guessing the correct isogeny required 3.20s
----------------------------------------------------------------------
Secret key recovered: 314226774
The attack is successful: True
----------------------------------------------------------------------
Altogether, the attack required 37.79s
```
